<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Player with PiP</title>
    <style>
        #playPauseButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 40px 80px;
            font-size: 50px;
        }
        #audioVideo {
            width: 0;
            height: 0;
            position: absolute;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <button id="playPauseButton">Play</button>
    <video id="audioVideo" controls></video>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        let player;
        let device_id = null;
        let deviceReady = false;
        let token = null;
        let currentUri = null;
        let isPlaying = false;
        let playRetryAttempts = 0;
        const maxRetryAttempts = 4;

        const videoElement = document.getElementById('audioVideo');

        window.onSpotifyWebPlaybackSDKReady = () => {
            const urlParams = new URLSearchParams(window.location.search);
            token = urlParams.get('access_token');
            currentUri = urlParams.get('uri');

            console.log('Page loaded. Token:', token);
            console.log('Spotify URI:', currentUri);

            if (!token) {
                console.error('Access token not found in URL');
                return;
            }

            player = new Spotify.Player({
                name: 'Web Playback SDK Quick Start Player',
                getOAuthToken: cb => { cb(token); },
                volume: 0.5
            });

            player.addListener('initialization_error', ({ message }) => console.error('Failed to initialize', message));
            player.addListener('authentication_error', ({ message }) => console.error('Failed to authenticate', message));
            player.addListener('account_error', ({ message }) => console.error('Failed to validate Spotify account', message));
            player.addListener('playback_error', ({ message }) => console.error('Failed to perform playback', message));

            player.addListener('ready', ({ device_id }) => {
                console.log('Connected with Device ID', device_id);
                window.device_id = device_id;
                deviceReady = true;
                updateDeviceStatus();

                if (currentUri) {
                    attemptToPlay(currentUri);
                }
            });

            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID is not ready for playback', device_id);
                deviceReady = false;
                updateDeviceStatus();
            });

            player.addListener('player_state_changed', state => {
                console.log('Player state changed:', state);
                isPlaying = !state.paused;
                updateButtonLabel();
            });

            console.log('Attempting to connect to the player...');
            player.connect().then(success => {
                if (success) {
                    console.log('The Web Playback SDK successfully connected to Spotify!');
                } else {
                    console.error('Failed to connect to Spotify.');
                }
            });

            videoElement.addEventListener('enterpictureinpicture', () => {
                console.log('Entered PiP mode');
                if (!isPlaying && deviceReady) {
                    player.resume().catch(error => console.error('Failed to resume playback in PiP:', error));
                }
            });

            videoElement.addEventListener('leavepictureinpicture', () => {
                console.log('Left PiP mode');
            });
        };

        function togglePlayPause() {
            if (!player || !deviceReady || !window.device_id) {
                console.error('Player not initialized or not ready');
                return;
            }

            if (isPlaying) {
                player.pause().then(() => {
                    videoElement.pause();
                    console.log('Playback paused');
                    isPlaying = false;
                    updateButtonLabel();
                }).catch(error => console.error('Error pausing playback:', error));
            } else {
                player.resume().then(() => {
                    videoElement.play();
                    console.log('Playback resumed');
                    isPlaying = true;
                    updateButtonLabel();
                }).catch(error => console.error('Error resuming playback:', error));
            }
        }

        function playSpotifyTrack(uri) {
            console.log('Attempting to play track with URI:', uri);
            if (!player || !deviceReady || !window.device_id) {
                console.error('Player not initialized or not ready');
                return;
            }

            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${window.device_id}`, {
                method: 'PUT',
                body: JSON.stringify({ uris: [uri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            }).then(response => {
                if (response.ok) {
                    videoElement.src = currentUri;
                    videoElement.play();
                    videoElement.requestPictureInPicture(); // 请求进入PiP模式
                    console.log('Playback started successfully');
                    isPlaying = true;
                    updateButtonLabel();
                } else {
                    console.error('Playback failed with status:', response.status);
                    retryPlay(uri);
                }
            }).catch(error => {
                console.error('Error starting playback:', error);
                retryPlay(uri);
            });
        }

        function retryPlay(uri) {
            if (playRetryAttempts < maxRetryAttempts) {
                playRetryAttempts++;
                console.log(`Retrying to play track (attempt ${playRetryAttempts})...`);
                setTimeout(() => playSpotifyTrack(uri), 2000);
            } else {
                console.error('Max retry attempts reached. Playback failed.');
            }
        }

        function attemptToPlay(uri) {
            playSpotifyTrack(uri);
        }

        function updateButtonLabel() {
            const button = document.getElementById('playPauseButton');
            button.textContent = isPlaying ? 'Pause' : 'Play';
        }

        function updateDeviceStatus() {
            console.log('Device Ready State:', deviceReady);
            console.log('Device ID:', window.device_id);
        }

        document.getElementById('playPauseButton').addEventListener('click', togglePlayPause);
    </script>
</body>
</html>

