<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fff;
            color: #666666;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .player-container {
            width: 85%;
            max-width: 350px;
            text-align: center;
        }
        .cover-image {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }
        .title {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0 5px;
            text-align: left;
        }
        .artist {
            font-size: 16px;
            color: #b3b3b3;
            margin-bottom: 15px;
            text-align: left;
        }
        .progress-bar {
            width: 100%;
            margin-bottom: 10px;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar::-webkit-slider-runnable-track {
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #ffffff;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            z-index: 3;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        .progress-bar::before {
            content: '';
            height: 100%;
            width: 0;
            background-color: #9d1dca;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 2;
        }
        .controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 15px;
        }
        .control-button {
            font-size: 25px;
            color: #9d1dca;
            cursor: pointer;
        }
        .time-container {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #b3b3b3;
            margin-top: -10px;
        }
        /* 禁用长按按钮的默认行为 */
        button, .control-button {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <img id="coverImage" class="cover-image" src="default-image.png" alt="Cover Image" />
        <div id="title" class="title">Title</div>
        <div id="artist" class="artist">Artist</div>
        <input type="range" id="progressBar" class="progress-bar" value="0" min="0" max="100">
        <div class="time-container">
            <span id="currentTime">00:00</span>
            <span id="duration">00:00</span>
        </div>
        <div class="controls">
            <span id="previousButton" class="control-button">⏮️</span>
            <span id="playPauseButton" class="control-button">▶️</span>
            <span id="nextButton" class="control-button">⏭️</span>
        </div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        let player;
        let device_id = null;
        let deviceReady = false;
        let token = null;
        let currentUri = null;
        let isPlaying = false;

        window.onSpotifyWebPlaybackSDKReady = () => {
            const urlParams = new URLSearchParams(window.location.search);
            token = urlParams.get('access_token');
            currentUri = urlParams.get('uri');

            if (!token) {
                console.error('Access token not found in URL');
                return;
            }

            player = new Spotify.Player({
                name: 'Web Playback SDK Player',
                getOAuthToken: cb => { cb(token); },
                volume: 0.5
            });

            player.addListener('ready', ({ device_id }) => {
                window.device_id = device_id;
                deviceReady = true;
                if (currentUri) {
                    playSpotifyTrack(currentUri);
                }
            });

            player.addListener('player_state_changed', state => {
                if (state) {
                    isPlaying = !state.paused;
                    updateUI(state.track_window.current_track);
                    updateProgress(state);
                    updateButtonLabel();
                }
            });

            player.connect();
        };

        function playSpotifyTrack(uri) {
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${window.device_id}`, {
                method: 'PUT',
                body: JSON.stringify({ uris: [uri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            }).then(response => {
                if (!response.ok) {
                    console.error('Playback failed with status:', response.status);
                }
            });
        }

        function updateUI(track) {
            document.getElementById('coverImage').src = track.album.images[0].url;
            document.getElementById('title').textContent = track.name;
            document.getElementById('artist').textContent = track.artists.map(artist => artist.name).join(', ');
            document.getElementById('duration').textContent = formatTime(track.duration_ms / 1000);
            document.getElementById('progressBar').max = track.duration_ms / 1000;
        }

        function updateProgress(state) {
            const progressBar = document.getElementById('progressBar');
            const currentTime = document.getElementById('currentTime');
            const progressBarFilled = progressBar.querySelector('::before');

            progressBar.value = state.position / 1000;
            currentTime.textContent = formatTime(state.position / 1000);

            if (progressBarFilled) {
                progressBarFilled.style.width = `${(state.position / state.duration) * 100}%`;
            }

            if (!state.paused) {
                requestAnimationFrame(() => updateProgress(state));
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes < 10 ? '0' : ''}${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        function updateButtonLabel() {
            const button = document.getElementById('playPauseButton');
            button.textContent = isPlaying ? '⏸️' : '▶️';
        }

        document.getElementById('playPauseButton').addEventListener('click', () => {
            if (isPlaying) {
                player.pause();
            } else {
                player.resume();
            }
        });

        document.getElementById('previousButton').addEventListener('click', () => {
            player.previousTrack();
        });

        document.getElementById('nextButton').addEventListener('click', () => {
            player.nextTrack();
        });

        document.getElementById('progressBar').addEventListener('input', (e) => {
            player.seek(e.target.value * 1000);
        });
    </script>
</body>
</html>

