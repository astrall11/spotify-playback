// Initialize variables
let player;
let isPlaying = false;
let isSeeking = false;
let currentPosition = 0;
let duration = 0;

window.onSpotifyWebPlaybackSDKReady = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('access_token');
    const currentUri = urlParams.get('uri');

    player = new Spotify.Player({
        name: 'Web Playback SDK Player',
        getOAuthToken: cb => { cb(token); },
        volume: 0.5
    });

    player.addListener('ready', ({ device_id }) => {
        if (currentUri) {
            playSpotifyTrack(currentUri, device_id);
        }
    });

    player.addListener('player_state_changed', state => {
        if (!state) return;

        isPlaying = !state.paused;
        duration = state.duration / 1000; // Convert to seconds
        currentPosition = state.position / 1000; // Convert to seconds
        updateUI(state.track_window.current_track);
        updateButtonLabel();

        if (!isSeeking) {
            updateProgress();
        }
    });

    player.connect();
};

function playSpotifyTrack(uri, device_id) {
    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
        method: 'PUT',
        body: JSON.stringify({ uris: [uri] }),
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
    }).then(response => {
        if (!response.ok) {
            console.error('Playback failed with status:', response.status);
        }
    });
}

function updateUI(track) {
    document.getElementById('coverImage').src = track.album.images[0].url;
    document.getElementById('title').textContent = track.name;
    document.getElementById('artist').textContent = track.artists.map(artist => artist.name).join(', ');
    document.getElementById('duration').textContent = formatTime(duration);
    document.getElementById('progressBar').max = duration;
}

function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    const progressFilled = document.getElementById('progressFilled');
    const currentTime = document.getElementById('currentTime');

    currentTime.textContent = formatTime(currentPosition);
    progressBar.value = currentPosition;
    progressFilled.style.width = `${(currentPosition / duration) * 100}%`;

    if (isPlaying && !isSeeking) {
        currentPosition += 0.1; // Assuming this function is called every 100ms
        requestAnimationFrame(updateProgress);
    }
}

function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes < 10 ? '0' : ''}${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
}

function updateButtonLabel() {
    const button = document.getElementById('playPauseButton');
    button.textContent = isPlaying ? '⏸️' : '▶️';
}

document.getElementById('playPauseButton').addEventListener('click', () => {
    if (isPlaying) {
        player.pause();
    } else {
        player.resume();
    }
});

document.getElementById('progressBar').addEventListener('input', (e) => {
    isSeeking = true;
    currentPosition = e.target.value;
    updateProgress(); // Immediately reflect the change in the UI
});

document.getElementById('progressBar').addEventListener('change', (e) => {
    isSeeking = false;
    player.seek(currentPosition * 1000); // Convert to milliseconds
});

